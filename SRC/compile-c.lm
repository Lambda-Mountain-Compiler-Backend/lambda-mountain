
compile-c := Î» . (: (
   (print 'Compile.C.1\n_s)
   (let preview-program ast-parsed-program)
   (let typedefs ASTEOF)
   (while (non-zero preview-program) (match preview-program (
      ()
      ( (Seq( rst (Glb( k_t rhs )) )) (
         (if (==( k 'main_s )) (set assemble-argv-referenced True_u8) ())
         (let kt (typeof rhs))
         (let fragment (fragment::new()))
         (if (is-open kt) () (
            (if (is-blob kt) (
               (set fragment (fragment::set-term( fragment rhs )))
               (set fragment (fragment::set-type( fragment kt )))
               (set global-ctx (fragment-context::bind(
                  global-ctx k kt fragment
               )))
            ) (
               (set fragment (fragment::set( fragment 'fragment-type_s (SAtom 'Global_s) )))
               (if (is-arrow kt) (
                  (set fragment (fragment::set-type( fragment kt )))
                  (set global-ctx (fragment-context::bind(
                     global-ctx k kt fragment
                  )))
               ) (
                  (let clean-tt (without-representation kt))
                  (let repr-tt (and( clean-tt (t1 'GlobalVariable_s) )))
                  (set fragment (fragment::set-type( fragment (without-constructor repr-tt) )))
                  (let mid (mangle-identifier( k clean-tt )))
                  (set fragment (fragment::set( fragment 'expression_s (SAtom mid) )))
                  (set global-ctx (fragment-context::bind(
                     global-ctx k (without-constructor repr-tt) fragment
                  )))
               ))
            ))
         ))
         (set preview-program rst)
      ))
      ( (Seq( rst (@( td (Typedef( _ _ )) )) )) (
         (set typedefs (Seq( (close typedefs) (close td) )))
         (set preview-program rst)
      ))
      ( (Seq( rst _ )) (
         (set preview-program rst)
      ))
   )))
   (print 'Compile.C.2\n_s)
   (let pre-typedefs typedefs)
   (while (non-zero pre-typedefs) (match pre-typedefs (
      ()
      ( (Seq( rst (Typedef( (Lit( lhs _ )) rhs )) )) (
         (compile-c-typedef-ordinal(parse-type lhs)) 
         (set pre-typedefs rst)
      ))
   )))
   (print 'Compile.C.3\n_s)
   (while (non-zero typedefs) (match typedefs (
      ()
      ( (Seq( rst (Typedef( (Lit( lhs _ )) rhs )) )) (
         (compile-c-typedef( (parse-type lhs) rhs ))
         (set typedefs rst)
      ))
   )))
   (print 'Compile.C.4\n_s)
   (try-continue-compile-c-typedefs())
   (print 'Compile.C.5\n_s)
   (compile-program-ordered( global-ctx ast-parsed-program ))
   (print 'Compile.C.6\n_s)
   (compile-finish())
   (print 'Compile.C.7\n_s)
   (compile-write())
   (print 'Compile.C.8\n_s)
) Nil);
