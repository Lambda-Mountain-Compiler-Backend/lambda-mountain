
tokenize := Î»(: fp String). (: (tail(
   (let text (read-file fp))
   (let in_comment False_u8)
   (let buffer SNil)
   (let current-line 1_u64)
   (let current-column 1_u64)
   (let token-line 1_u64)
   (let token-column 1_u64)
   (let parens-counter 0_u64)
   (while (head-string text) (tail(
      (match (head-string text) (
         ()
         ( '\n_u8 (tail(
            (set current-line (+( current-line 1_u64 )))
            (set current-column 1_u64)
         )))
         ( _ (
            (set current-column (+( current-column 1_u64 )))
         ))
      ))
      (match (head-string text) (
         ()
         ( \o_u8 (tail(
            (if (non-zero buffer) (tail(
               (let tk (clone-rope buffer))
               (map-location( tk fp token-line token-column ))
               (set ast-tokenized-program (SCons(
                  (close ast-tokenized-program)
                  (close (SAtom tk))
               )))
               (set buffer SNil)
            )) ())
            (set token-line current-line)
            (set token-column current-column)
            (set in_comment True_u8)
         )))
         ( \n_u8 (tail(
            (if (non-zero buffer) (tail(
               (let tk (clone-rope buffer))
               (map-location( tk fp token-line token-column ))
               (set ast-tokenized-program (SCons(
                  (close ast-tokenized-program)
                  (close (SAtom tk))
               )))
               (set buffer SNil)
            )) ())
            (set token-line current-line)
            (set token-column current-column)
            (set in_comment False_u8)
         )))
         ( \t_u8 (tail(
            (if (non-zero buffer) (tail(
               (let tk (clone-rope buffer))
               (map-location( tk fp token-line token-column ))
               (set ast-tokenized-program (SCons(
                  (close ast-tokenized-program)
                  (close (SAtom tk))
               )))
               (set buffer SNil)
            )) ())
            (set token-line current-line)
            (set token-column current-column)
         )))
         ( \s_u8 (tail(
            (if (non-zero buffer) (tail(
               (let tk (clone-rope buffer))
               (map-location( tk fp token-line token-column ))
               (set ast-tokenized-program (SCons(
                  (close ast-tokenized-program)
                  (close (SAtom tk))
               )))
               (set buffer SNil)
            )) ())
            (set token-line current-line)
            (set token-column current-column)
         )))

         ( \[_u8 (if (==( in_comment True_u8 )) () (tail(
            (if (non-zero buffer) (tail(
               (let tk (clone-rope buffer))
               (map-location( tk fp token-line token-column ))
               (set ast-tokenized-program (SCons(
                  (close ast-tokenized-program)
                  (close (SAtom tk))
               )))
               (set buffer SNil)
            )) ())
            (set parens-counter (+( parens-counter 1_u64 )))
            (set ast-tokenized-program (SCons(
               (close ast-tokenized-program)
               (close (SAtom '\[_s))
            )))
            (set token-line current-line)
            (set token-column current-column)
         ))))
         ( \]_u8 (if (==( in_comment True_u8 )) () (tail(
            (if (non-zero buffer) (tail(
               (let tk (clone-rope buffer))
               (map-location( tk fp token-line token-column ))
               (set ast-tokenized-program (SCons(
                  (close ast-tokenized-program)
                  (close (SAtom tk))
               )))
               (set buffer SNil)
            )) ())
            (set parens-counter (-( parens-counter 1_u64 )))
            (set ast-tokenized-program (SCons(
               (close ast-tokenized-program)
               (close (SAtom '\]_s))
            )))
         ))))
         ( \`_u8 (if (==( in_comment True_u8 )) () (tail(
            (if (non-zero buffer) (tail(
               (let tk (clone-rope buffer))
               (map-location( tk fp token-line token-column ))
               (set ast-tokenized-program (SCons(
                  (close ast-tokenized-program)
                  (close (SAtom tk))
               )))
               (set buffer SNil)
            )) ())
            (set ast-tokenized-program (SCons(
               (close ast-tokenized-program)
               (close (SAtom \`_s))
            )))
         ))))
         ( \:_u8 (if (==( in_comment True_u8 )) () (tail(
            (if (non-zero buffer) (tail(
               (let tk (clone-rope buffer))
               (map-location( tk fp token-line token-column ))
               (set ast-tokenized-program (SCons(
                  (close ast-tokenized-program)
                  (close (SAtom tk))
               )))
               (set buffer SNil)
            )) ())
            (set ast-tokenized-program (SCons(
               (close ast-tokenized-program)
               (close (SAtom '\:_s))
            )))
         ))))

         ( c (if (==( in_comment True_u8 )) () (tail(
            (set buffer (SCons(
               (close buffer)
               (close (SAtom (clone-rope c)))
            )))
            (if (==( '\l_s (clone-rope buffer) )) (tail(
               (set ast-tokenized-program (SCons(
                  (close ast-tokenized-program)
                  (close (SAtom '\l_s))
               )))
               (set buffer SNil)
           )) ())
         ))))
      ))
      (set text (tail-string text))
   )))

   (if (non-zero buffer) (
      (set ast-tokenized-program (SCons(
         (close ast-tokenized-program)
         (close (SAtom (clone-rope buffer)))
      )))
   ) ())

   (if (==( parens-counter 0_u64 )) () (tail(
      (eprint 'Hanging\sParentheses\sIn\sFile:\s_s)
      (eprint fp)
      (eprint '\sCount:\s_s)
      (print parens-counter)
      (eprint '\n_s)
      (exit 1_u64)
   )))

   (let r (maybe-deref(list-tail-order-to-head-order ast-tokenized-program)))
   (set ast-tokenized-program r)
)) Nil);

